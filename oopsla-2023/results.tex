\newcommand{\numgtp}{}
\newcommand{\boundaryMB}{527}
\newcommand{\statisticalMB}{4010}
\newcommand{\runtimeMB}{44}


%% \bg{TODO rerun snake profile, have "snake" not "usnake" just in case}
%% should not matter but still

We have conducted a rational programmer experiment
using the FILL strategies
on FILL of the GTP benchmarks~\cite{}.


\subsection{Data Collection}

Executing a rational programmer requires two kinds of ground-truth data:
running times and profiler results.

FILL collected between July 2022 and today (ongoing).
Over 4GB of data, combined.
%% \boundaryMB + \statisticalMB + \runtimeMB
quadT runtime between August 2022 and October 2022, since then, unable to get a huge
block of machines for the profile and boundary data.




FILL explain "u" setup, appendix?


% https://www.cloudlab.us/

Our experiments call for three kinds of data for every configuration across the benchmarks:
\begin{enumerate}
  \item Running time
  \item Boundary-profile output
  \item Statistical-profile output
\end{enumerate}

To collect one running time, we used nine runs of the configuration:
one throwaway run to warm up the Racket JIT and eight other runs to compute an average.
To collect boundary and statistical output, we ran each configuration once.
Thus we took $11 * \totalnumconfigs{} = \totalnummeasurements{}$ measurements in total.

We collected all the data on CloudLab~[CITE].
For running times, we used the Wisconsin cluster c220g1 
FILL: exception for morsecode.

FILL: exact racket/tr code available on zenodo

FILL: footnote, quadT in the works; report current status

boundary from another cluster, same racket
exceptions: dungeon, morsecode
profile, ditto

Tried two modes for statistical profiler: total time and self time.
Comparable, but total succeeds in a greater number of configurations.
There do exist configs where total fails and self succeeds.
Focus on total for most of paper (TODO where?)


\begin{table}[t]
  \caption{Datasets}
  \label{t:data-collection}

  \begin{tabular}{llll}
    Dataset           & Server & Racket & Typed Racket \\\midrule
    dungeon           & \machinename{c220g2} & \stdrkt{} &  \commitname{29ea3c10}{29ea3c105e0bd60b88c1fd195b54fa716863f690} \\
    morsecode         & \machinename{m510}   & same & \commitname{700506ca}{700506ca01393f211229101c47d8420f6d535de9} (cherry pick) \\
 %% quadT runtime  & \machinename{m510}   & same & same \\
    other runtime     & \machinename{c220g1} & same & default \\
    profilers         & \machinename{m510}   & same & same
  \end{tabular}

  \bigskip

  \begin{tabular}{llrrr}
    %% multi-cpu, multi-core machines .. but we didn't use that, right?
    Server & Site & CPU Speed & RAM & Disk \\\midrule
    \machinename{c220g1} & Wisconsin & 2.4GHz & 128GB & 480GB SSD \\
    \machinename{c220g2} & Wisconsin & 2.6GHz & 160GB & 480GB SSD \\
    \machinename{m510}   & Utah      & 2.0GHz &  64GB & 256GB SSD
  \end{tabular}
\end{table}




For our experiments, we consider every configuration as a starting point.
From the starting point, the goal is to reach a fast configuration without
removing types from a module.
(In other words, the \emph{target} is the set of typed modules in the start
configuration.)
A fast configuration runs at least as quickly as the untyped code.
Using the established terminology~\cite{vss-popl-2017,bbst-oopsla-2017},
we instatiate the Takikawa constant to 1x ($T=1$).

A very simple way to try improving performance is to toggle between
Deep and Shallow.
\citet{g-deep-shallow} provides justification.
Any configuration can reach 0, 1, or 2 other configurations by
toggling, that is, by changing all its typed modules to Deep or
changing all to Shallow.
(Only the untyped configuration can reach 0 others.)

First question: for how many configurations does $T=1$ present a debugging challenge?
More precisely, how many cannot reach $T=1$ by toggling?

(The untyped configuration can trivially reach $T=1$.
The fully-typed configuration can usually reach $T=1$, unless there are heavy
boundaries to untyped contextual modules.)

\Cref{t:baseline-trouble} shows that many benchmarks need help,
over 100k configurations in total.
The median \% that need help is 82\%.
Only \bmname{fsm} and \bmname{lnm} have low percentages: 8\% and 44\%.
FILL say more

\begin{table}[t]
  \caption{How many of the $3^N$ configurations have any overhead to begin with?}
  \label{t:baseline-trouble}
  \begin{tabular}[t]{l@{\qquad}l}
    \begin{tabular}[t]{lrr}
      Benchmark           & $3^N$ & \% Slow \\\midrule
      \bmname{morsecode}  &    81 & 82.72\% \\
      \bmname{forth}      &    81 & 93.83\% \\
      \bmname{fsm}        &    81 & \ycell{76.54\%} \\
      \bmname{fsmoo}      &    81 & 83.95\% \\
      \bmname{mbta}       &    81 & 88.89\% \\
      \bmname{zombie}     &    81 & 91.36\% \\
      \bmname{dungeon}    &   243 & 99.59\% \\
      \bmname{jpeg}       &   243 & 94.65\% \\
    \end{tabular}
    &
    \begin{tabular}[t]{lrr}
      Benchmark           & $3^N$ & \% Slow \\\midrule
      \bmname{lnm}        &   729 & \ycell{40.47\%} \\
      \bmname{suffixtree} &   729 & 98.49\% \\
      \bmname{kcfa}       &  2187 & 92.87\% \\
      \bmname{snake}      &  6561 & 99.97\% \\
      \bmname{take5}      &  6561 & 99.95\% \\
      \bmname{acquire}    & 19683 & 99.23\% \\
      \bmname{tetris}     & 19683 & 95.47\% \\
      \bmname{synth}      & 59049 & 99.99\%
    \end{tabular}
  \end{tabular}
\end{table}

\begin{figure}[t]
  \includegraphics[width=\columnwidth]{data/strategy-overall-feasible.pdf}
  \caption{Strategy head-to-head, mono only, 114,428 scenarios. Profiles on left. Agnostics on right. RandomB is average of 3 runs, max stddev <0.1}
  \label{f:strategy-overall}
\end{figure}

\begin{table}[t]
  \caption{How many of the $3^N$ configurations cannot reach 1x without removing types?}
  \label{t:blackhole}
  \begin{tabular}[t]{l@{\qquad}l}
    \begin{tabular}[t]{lrr}
Benchmark           & $3^N$ & \% Hopeless \\\midrule
\bmname{morsecode}  &    81 &         0\% \\
\bmname{forth}      &    81 &      59.26\% \\
\bmname{fsm}        &    81 &         0\% \\
\bmname{fsmoo}      &    81 &         0\% \\
\bmname{mbta}       &    81 &      88.89\% \\
\bmname{zombie}     &    81 &      59.26\% \\
\bmname{dungeon}    &   243 &      99.59\% \\
\bmname{jpeg}       &   243 &         0\%
    \end{tabular}
    &
    \begin{tabular}[t]{lrr}
Benchmark           & $3^N$ & \% Hopeless \\\midrule
\bmname{lnm}        &   729 &         0\% \\
\bmname{suffixtree} &   729 &         0\% \\
\bmname{kcfa}       &  2187 &         0\% \\
\bmname{snake}      &  6561 &         0\% \\
\bmname{take5}      &  6561 &      99.95\% \\
\bmname{acquire}    & 19683 &      93.83\% \\
\bmname{tetris}     & 19683 &         0\% \\
\bmname{synth}      & 59049 &         0\%
    \end{tabular}
  \end{tabular}
\end{table}

\begin{figure}[t]
  \includegraphics[width=0.8\columnwidth]{data/strategy-overall-hopeful.pdf}
  \caption{Hopeful only, 88,992 scenarios. RandomB is average of 3 runs, max stddev <0.12}
  \label{f:strategy-hope}
\end{figure}

\begin{figure}[t]
  \includegraphics[width=0.9\columnwidth]{data/head-to-head.pdf}
  \caption{Opt vs everyone, all scenarios}
  \label{f:head-to-head}
\end{figure}

\clearpage

